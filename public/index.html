<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noticias e Infografías</title>
    
    <script>
        function openNav() {
            document.getElementById("mySidenav").style.width = "250px";
        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
        }
    </script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; }
        h1 { text-align: center; color: #333; }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 5px; color: #444; margin-top: 40px; }

        /* --- ESTILOS DEL MENÚ LATERAL (SIDENAV) --- */
        .sidenav {
            height: 100%;
            width: 0; 
            position: fixed;
            z-index: 1000;
            top: 0;
            right: 0; 
            background-color: #111;
            overflow-x: hidden;
            transition: 0.5s; 
            padding-top: 60px;
            display: flex;
            flex-direction: column; 
        }

        .sidenav a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 25px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        .sidenav a:hover { color: #f1f1f1; }

        .sidenav .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }

        .sidenav .admin-bottom {
            margin-top: auto; 
            margin-bottom: 20px;
            color: #007bff;
            font-size: 20px;
            border-top: 1px solid #333;
            padding-top: 20px;
        }

        .burger-icon {
            font-size: 30px;
            cursor: pointer;
            color: #333;
            position: absolute;
            right: 20px;
            top: 25px;
        }

        @media (max-width: 600px) {
            .burger-icon { top: 20px; }
            .responsive-logo { max-height: 40px; }
            .main-header h1 { font-size: 1.2rem; margin-left: 10px; }
        }

        /* --- HEADER --- */
        .main-header {
            display: flex;
            align-items: center; 
            background-color: #ffffff; 
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .responsive-logo {
            max-height: 60px; 
            width: auto;      
            display: block;
        }

        /* --- ACORDEÓN (HISTORIAL) --- */
        .accordion-btn {
            background-color: #e9ecef;
            color: #444;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1.2rem;
            transition: 0.4s;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .accordion-btn:hover { background-color: #dbe0e5; }
        .accordion-btn.active { background-color: #007bff; color: white; }

        .panel-historial {
            padding: 0 5px;
            background-color: transparent;
            max-height: 0; 
            overflow: hidden;
            transition: max-height 0.3s ease-out; 
            margin-bottom: 20px;
        }

        .rotate-icon { transition: transform 0.3s ease; }
        .accordion-btn.active .rotate-icon { transform: rotate(180deg); }

        /* --- UBICACIÓN --- */
        .ubicacion-section {
            text-align: center;
            padding: 40px 20px;
            background-color: #f9f9f9;
        }

        .mapa-container iframe {
            width: 100%;       
            max-width: 800px;  
            height: 300px;     
            border-radius: 10px;
        }

        .btn-mapa {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #4285F4;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }

        /* --- CONTENEDOR DE TARJETAS --- */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 15px; }
        
        .card { background: white; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }
        .card-header { padding: 15px; background: #007bff; color: white; }
        .card-header h3 { margin: 0; font-size: 1.2em; }
        .fechas { font-size: 0.8em; opacity: 0.9; margin-top: 5px; }

        /* --- TABS --- */
        .tabs { display: flex; background: #eee; overflow-x: auto; }
        .tab-btn { flex: 1; border: none; background: #eee; padding: 10px; cursor: pointer; font-weight: bold; color: #555; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab-btn:hover { background: #ddd; }
        .tab-btn.active { border-bottom: 3px solid #007bff; color: #007bff; background: white; }

        /* --- IMÁGENES DENTRO DE LA TARJETA --- */
        .img-container { height: 300px; background: #ddd; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .img-container img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            cursor: pointer; /* Cambia a manita */
            transition: transform 0.3s; /* Animación suave */
        } 
        /* Efecto hover: se agranda un poco al pasar el mouse */
        .img-container img:hover { transform: scale(1.03); }
        
        .seccion-vacia { color: #888; font-style: italic; }

        /* --- FOOTER --- */
        .main-footer {
            background-color: #222;
            color: white;
            text-align: center;
            padding: 30px 0;
            margin-top: auto;
        }

        .social-icons { margin: 20px 0; }
        .social-link {
            display: inline-flex; justify-content: center; align-items: center; width: 40px; height: 40px; margin: 0 10px;
            border-radius: 50%; background-color: #444; color: white; text-decoration: none; font-size: 1.2rem; transition: 0.3s;
        }

        .social-link.facebook:hover { background-color: #3b5998; }
        .social-link.instagram:hover { background-color: #C13584; }
        .social-link.twitter:hover { background-color: #1DA1F2; }
        .social-link.whatsapp:hover { background-color: #25D366; }
        .social-link.tiktok:hover { background-color: #fe2c55; }
        .social-link.campfire:hover { background-color: #ff6c2f; }

        /* =========================================================
           ESTILOS DEL LIGHTBOX (VISOR DE IMAGEN AGRANDADA) 
           ========================================================= */
        .lightbox {
            display: none; /* Oculto por defecto */
            position: fixed;
            z-index: 9999; /* Por encima de todo */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Fondo oscuro transparente */
            backdrop-filter: blur(8px); /* EFECTO BORROSO DE FONDO */
            justify-content: center;
            align-items: center;
        }

        .lightbox-content {
            max-width: 90%;
            max-height: 85%;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            object-fit: contain;
            animation: zoomIn 0.3s ease; /* Pequeño salto al abrir */
        }

        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Contenedor de los botones superiores */
        .lightbox-controls {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            gap: 20px;
        }

        /* Botones de descargar y cerrar */
        .lightbox-btn {
            color: white;
            font-size: 35px;
            cursor: pointer;
            transition: 0.3s;
            text-decoration: none;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
        }

        .lightbox-btn:hover {
            color: #007bff;
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
        }
    </style>
</head>
<body>

    <div id="miLightbox" class="lightbox">
        <div class="lightbox-controls">
            <a id="btn-descargar" class="lightbox-btn" title="Descargar Imagen">
                <i class="fas fa-download"></i>
            </a>
            <span class="lightbox-btn" onclick="cerrarLightbox()" title="Minimizar">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <img id="lightbox-img" class="lightbox-content" src="">
    </div>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>
        <a href="/index.html"><i class="fas fa-home"></i> Inicio</a>
        <a href="/calculadora.html"><i class="fas fa-calculator"></i> Calculadora Tipos</a>
        <a href="/login.html" class="admin-bottom"><i class="fas fa-user-shield"></i> Ir al Admin</a>
    </div>

    <header class="main-header">
        <div class="logo-container">
            <img src="/uploads/logo.png" alt="Logo del Evento" class="responsive-logo">
        </div>
        <h1>Noticias del Evento</h1>
        
        <span class="burger-icon" onclick="openNav()">
            <i class="fas fa-bars"></i>
        </span>
    </header>

    <h1>Portal de Eventos</h1>

    <h2><i class="fas fa-fire" style="color: #ff4500;"></i> Eventos Activos</h2>
    <div id="container-activos" class="grid-container"></div>

    <h2><i class="fas fa-calendar-alt" style="color: #007bff;"></i> Próximos Eventos</h2>
    <div id="container-proximos" class="grid-container"></div>

    <h2 style="margin-top: 50px;">Historial</h2>
    <button class="accordion-btn" onclick="toggleHistorial()">
        <span><i class="fas fa-history"></i> Ver Eventos Pasados</span>
        <i class="fas fa-chevron-down rotate-icon"></i>
    </button>
    <div id="historial-wrapper" class="panel-historial">
        <div id="container-pasados" class="grid-container"></div>
    </div>


    <script>
        function toggleHistorial() {
            const btn = document.querySelector('.accordion-btn');
            const panel = document.getElementById('historial-wrapper');
            btn.classList.toggle("active");
            if (panel.style.maxHeight) {
                panel.style.maxHeight = null; 
            } else {
                panel.style.maxHeight = panel.scrollHeight + "px"; 
            }
        }

        async function cargarNoticias() {
            try {
                const response = await fetch('/api/noticias');
                const noticias = await response.json();
                const ahora = new Date();

                const cActivos = document.getElementById('container-activos');
                const cProximos = document.getElementById('container-proximos');
                const cPasados = document.getElementById('container-pasados');

                let countActivos = 0, countProximos = 0, countPasados = 0;

                noticias.forEach(noticia => {
                    const inicio = new Date(noticia.fecha_inicio);
                    const fin = new Date(noticia.fecha_fin);
                    
                    let contenido = noticia.contenido_json;
                    if (typeof contenido === 'string') {
                        contenido = JSON.parse(contenido);
                    }

                    let contenedorDestino;
                    if (ahora >= inicio && ahora <= fin) {
                        contenedorDestino = cActivos; countActivos++;
                    } else if (ahora < inicio) {
                        contenedorDestino = cProximos; countProximos++;
                    } else {
                        contenedorDestino = cPasados; countPasados++;
                    }

                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    let tabsHTML = '';
                    contenido.forEach((item, index) => {
                        const activeClass = index === 0 ? 'active' : '';
                        tabsHTML += `<button class="tab-btn ${activeClass}" onclick="cambiarPestana(this, '${item.imagen}')">${item.titulo}</button>`;
                    });

                    card.innerHTML = `
                        <div class="card-header">
                            <h3>${noticia.titulo_principal}</h3>
                            <div class="fechas">
                                Del: ${inicio.toLocaleDateString()} ${inicio.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} <br>
                                Al: ${fin.toLocaleDateString()} ${fin.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </div>
                        </div>
                        <div class="tabs">
                            ${tabsHTML}
                        </div>
                        <div class="img-container">
                            <img src="${contenido[0].imagen}" alt="Infografía" onclick="abrirLightbox(this.src)">
                        </div>
                    `;
                    contenedorDestino.appendChild(card);
                });

                if(countActivos === 0) cActivos.innerHTML = '<p class="seccion-vacia">No hay eventos activos en este momento.</p>';
                if(countProximos === 0) cProximos.innerHTML = '<p class="seccion-vacia">No hay eventos programados.</p>';
                if(countPasados === 0) cPasados.innerHTML = '<p class="seccion-vacia">No hay historial disponible.</p>';
                
            } catch (error) {
                console.error("Error cargando noticias:", error);
            }
        }

        window.cambiarPestana = function(boton, urlImagen) {
            const card = boton.closest('.card');
            const botones = card.querySelectorAll('.tab-btn');
            botones.forEach(btn => btn.classList.remove('active'));
            boton.classList.add('active');
            const img = card.querySelector('.img-container img');
            img.src = urlImagen;
        }

        // ==============================================
        // FUNCIONES DE JAVASCRIPT PARA EL LIGHTBOX
        // ==============================================

        // 1. Abrir la imagen en grande
        window.abrirLightbox = function(srcUrl) {
            const lightbox = document.getElementById("miLightbox");
            const imgLg = document.getElementById("lightbox-img");
            const btnDescargar = document.getElementById("btn-descargar");
            
            // Ponemos la URL de la imagen clickeada en la imagen en grande
            imgLg.src = srcUrl;
            
            // Configuramos la descarga usando un Blob para forzar al navegador a guardar
            btnDescargar.onclick = function(e) {
                e.preventDefault();
                // Mostramos un texto de que está cargando por si pesa mucho
                btnDescargar.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
                
                fetch(srcUrl)
                    .then(response => response.blob())
                    .then(blob => {
                        const blobUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = blobUrl;
                        a.download = 'infografia_pokemon_go.jpg'; // Nombre con el que se guarda
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(blobUrl);
                        // Regresar el icono a su estado normal
                        btnDescargar.innerHTML = '<i class="fas fa-download"></i>'; 
                    })
                    .catch(() => {
                        alert('Error al descargar la imagen.');
                        btnDescargar.innerHTML = '<i class="fas fa-download"></i>';
                    });
            };

            // Mostramos el fondo oscuro
            lightbox.style.display = "flex";
        }

        // 2. Cerrar (Minimizar) la imagen
        window.cerrarLightbox = function() {
            document.getElementById("miLightbox").style.display = "none";
        }

        // 3. Si el usuario da clic fuera de la foto (en lo borroso), también se cierra
        window.onclick = function(event) {
            const lightbox = document.getElementById("miLightbox");
            if (event.target == lightbox) {
                cerrarLightbox();
            }
        }

        cargarNoticias();
    </script>

    <section class="ubicacion-section">
        <h2>Ubicación de los eventos</h2>
        <p>Fuente de Neptuno, Alameda Central (Av. Juarez 58), Centro, Cuauhtémoc, 06050 Ciudad de México, CDMX</p>
        <div class="mapa-container">
            <iframe 
                width="100%" 
                height="450" 
                style="border:0;" 
                loading="lazy" 
                allowfullscreen 
                referrerpolicy="no-referrer-when-downgrade"
                src="https://maps.google.com/maps?q=Fuente+de+Neptuno+Alameda+Central&t=&z=18&ie=UTF8&iwloc=&output=embed">
            </iframe>
        </div>

        <a href="https://www.google.com.mx/maps/place/Fuente+de+Neptuno/@19.4356827,-99.1452984,18z/data=!4m14!1m7!3m6!1s0x85d1f92af577b44b:0xdb290ed58ba64e40!2sAlameda+Central!8m2!3d19.4359374!4d-99.1439285!16s%2Fm%2F02r4kv2!3m5!1s0x85d1f92a8636372f:0x292f260deb46b810!8m2!3d19.4355406!4d-99.1449982!16s%2Fg%2F11fj327s96" target="_blank" class="btn-mapa">
            Ver en Google Maps
        </a>
    </section>

    <footer class="main-footer">
        <h3>Síguenos en nuestras redes</h3>
        <div class="social-icons">
            <a href="https://www.facebook.com/groups/544183595780445/?ref=share&mibextid=NSMWBT" target="_blank" class="social-link facebook">
                <i class="fab fa-facebook-f"></i>
            </a>
            <a href="https://www.instagram.com/pokemongocdmxoficial?igsh=MTBpeXYwOHhvMHc4aw==" target="_blank" class="social-link instagram">
                <i class="fab fa-instagram"></i>
            </a>
            <a href="https://x.com/PoGoCDMXOficial" target="_blank" class="social-link twitter">
                <i class="fab fa-twitter"></i>
            </a>
            <a href=" https://whatsapp.com/channel/0029VbApOTO3rZZeh9PT3T1b" target="_blank" class="social-link whatsapp">
                <i class="fab fa-whatsapp"></i>
            </a>
            <a href="https://campfire.onelink.me/eBr8?af_dp=campfire://&af_force_deeplink=true&deep_link_sub1=cj1jbHVicyZjPTc3NDdjNGY0LWJhZTEtNDI1Yy1hOTZjLTliOTFjZGVlOTNjOCZpPXRydWU=" target="_blank" class="social-link campfire" target="_blank" class="social-link campfire">
                <i class="fas fa-fire"></i>
            </a>
            <a href="https://www.tiktok.com/@comunidadpokemongocdmx?_r=1&_t=ZS-9330qRSUTk8" target="_blank" class="social-link tiktok" target="_blank" class="social-link tiktok">
                <i class="fab fa-tiktok"></i>
            </a>
        </div>
        <p>© Yrodriguez90 - Todos los derechos reservados.</p>
    </footer>
</body>
</html>